<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Test</title>
<script type="text/javascript" src="/jmi-canvas/src/main/js/lib/jquery-1.7.1.min.js"></script>

<script type="text/javascript" src="/jmi-canvas/src/main/js/lib/json_sans_eval.js"></script>

<script type="text/javascript" src="/jmi-canvas/src/main/js/jmi.js"></script>

<script type="text/javascript" src="/jmi-canvas/src/main/js/script/ActiveZone.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/BagZone.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Base.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/ColorX.js"></script>
<!--script type="text/javascript" src="/jmi-canvas/src/main/js/script/CustomMenuItemRenderer.js"></script-->
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Dimension.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Env.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/FontX.js"></script>
<!--script type="text/javascript" src="/jmi-canvas/src/main/js/script/FormatToken.js"></script-->
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/HTMLText.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Insets.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/LinkZone.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/MenuX.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Plan.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/PlanContainer.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Point.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Polygon.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Rectangle.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/SatData.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Satellite.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/ShapeX.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Slice.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Swatch.js"></script>
<!--script type="text/javascript" src="/jmi-canvas/src/main/js/script/TextToken.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/TipTimer.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Token.js"></script-->
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/Transfo.js"></script>
<script type="text/javascript" src="/jmi-canvas/src/main/js/script/VContainer.js"></script>

<script type="text/javascript" src="/jmi-canvas/src/main/js/components/Map.js"></script>

</head>
<body>
<script>
$.get(
    "/jmi-canvas/src/main/resources/feeds.json",
    function( jmiJson) { 
		var jmiData = jsonParse( jmiJson, function (key, value) {
	        if (value && typeof value === 'object') {
	        	if( 'env' === key && value.hasOwnProperty('selections')) {
	        		var env = new JMI.script.Env();
	        		for (var attr in value) {
	        			env[attr] = value[attr];
    				}
    				return env;
	        	}
	        	else if( 'plan' === key && value.hasOwnProperty('nodes')) {
	        		var plan = new JMI.script.Plan();
	        		for (var attr in value) {
	        			plan[attr] = value[attr];
    				}
    				// Résolution des références
					var n = plan.nodes.length; 
					for( var i = 0; i < n; ++i) {
						// BagZone : append ActiveZone
						for (var az in plan.nodes[i].subZones) { 
							plan.nodes.push( az);
						}			
					}
					// Résolution des références
					// Convert from et to index to Bagzone reference
					for each (link in plan.links) { 
						if( link.from != -1) {
							link.from = plan.nodes[ link.from];
							link.props["_VERTICES"][0] = link.from.props["_VERTICES"][0];
						}
						if( link.to != -1) {
							link.to = plan.nodes[ link.to];
							link.props["_VERTICES"][1] = link.to.props["_VERTICES"][0];
						}
					} 
    				return plan;
	        	}
	        	else if( 'Transfo' === value.cls) {
	        		return new JMI.script.Transfo( value.dir, value.pos, value.scl, value.flags);
	        	}
	        	else if( 'Slice' === value.cls) {
	        		var slice = new JMI.script.Slice();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				slice[attr] = value[attr];
    				}
    				return slice;
	        	}
	        	else if( 'Satellite' === value.cls) {
	        		var slice = new JMI.script.Satellite();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				slice[attr] = value[attr];
    				}
    				return slice;
	        	}
	        	else if( 'Point' === value.cls) {
	        		return new JMI.script.Point( value.x, value.y);
	        	}
	        	else if( 'ColorX' === value.cls) {
	        		return new JMI.script.ColorX( value.color);
	        	}
	        	else if( 'VContainer' === value.cls) {
	        		return new JMI.script.VContainer( value.value, value.bound);
	        	}
	        	else if( 'ActiveZone' === value.cls) {
	        		var shape = new JMI.script.ActiveZone();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				shape[attr] = value[attr];
    				}
    				return shape;
    			}
	        	else if( 'BagZone' === value.cls) {
	        		var shape = new JMI.script.BagZone();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				shape[attr] = value[attr];
    				}
    				return shape;
    			}
	        	else if( 'LinkZone' === value.cls) {
	        		var shape = new JMI.script.LinkZone();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				shape[attr] = value[attr];
    				}
    				return shape;
    			}
	        	else if( 'ShapeX' === value.cls) {
	        		var shape = new JMI.script.ShapeX();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				shape[attr] = value[attr];
    				}
    				return shape;
    			}
	        	else if( 'MenuX' === value.cls) {
	        		var shape = new JMI.script.MenuX();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				shape[attr] = value[attr];
    				}
    				return shape;
    			}
	        	else if( 'FontX' === value.cls) {
	        		var shape = new JMI.script.FontX();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				shape[attr] = value[attr];
    				}
    				return shape;
    			}
	        	else if( 'Swatch' === value.cls) {
	        		var swatch = new JMI.script.Swatch();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				swatch[attr] = value[attr];
    				}
    				return swatch;
    			}
	        	else if( 'HtmlText' === value.cls) {
	        		var swatch = new JMI.script.HTMLText();
	        		for (var attr in value) {
	        			if( attr !== 'cls')
	        				swatch[attr] = value[attr];
    				}
    				return swatch;
		       	} else {
		       		if( value.hasOwnProperty('cls'))
		       			aptana.log( key + ' unconverted = ' + value.cls);
		         	return value;
		       	}
	       	} else {
	         	return value;
	       }
		}
		);
		alert( 'done');
    }
);
</script>	
</body>
</html>